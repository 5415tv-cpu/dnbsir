{% extends "base.html" %}

{% block title %}ë†ê°€ í†µí•© ì£¼ë¬¸ ê´€ë¦¬ - ë™ë„¤ë¹„ì„œ{% endblock %}

{% block content %}
<div
    style="background-color: #e0e0e0; padding: 25px; border: 3px solid #1a1a1a; border-radius: 10px; font-weight: 800; color: #1a1a1a; max-width: 500px; margin: 20px auto;">
    <h3 style="margin-top: 0; font-weight: 900; border-bottom: 2px solid #1a1a1a; padding-bottom: 10px;">ğŸšœ ë†ê°€ í†µí•© ì£¼ë¬¸ ê´€ë¦¬
    </h3>

    <!-- Products List (Mock for now) -->
    <div style="background: #fff; padding: 15px; border: 2px solid #1a1a1a; margin-bottom: 15px;">
        <div style="display: flex; gap: 15px; align-items: center;">
            <img src="/static/images/mock_cabbage.jpg" onerror="this.src='https://via.placeholder.com/60?text=IMG'"
                style="width: 60px; height: 60px; object-fit: cover; border: 1px solid #1a1a1a;">
            <div>
                <div style="font-weight: 900;">íƒœë°± ê³ ë­ì§€ ë°°ì¶” 10kg</div>
                <div style="font-size: 0.9rem; color: #d32f2f;">35,000ì› (íŒë§¤ì¤‘)</div>
            </div>
        </div>
    </div>

    <!-- Orders -->
    <div id="orderList">
        <!-- Loaded via JS -->
        <div style="background: #fff; padding: 15px; border: 2px solid #1a1a1a; margin-bottom: 10px;">
            <div style="font-size: 0.85rem; color: #555; margin-bottom: 10px;">ì‹ ê·œ ì£¼ë¬¸ (í™ê¸¸ë™ ë‹˜)</div>
            <div style="font-weight: 900; margin-bottom: 10px;">ê°•ì›ë„ íƒœë°±ì‹œ ë²ˆì˜ë¡œ 123</div>

            <button onclick="bookLogen('ORDER_123')"
                style="width: 100%; background: #1a1a1a; color: #fff; border: none; padding: 15px; font-size: 1rem; font-weight: 900; border-radius: 5px; cursor: pointer;">
                ğŸ“¦ í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ë¡œì  íƒë°° ì ‘ìˆ˜
            </button>
        </div>
    </div>

    <div style="margin-top: 15px; text-align: right; font-size: 0.85rem;">
        ì•Œë¦¼í†¡ ì”ì•¡: <span id="walletBalance">0</span>ì›
        <span id="autoRefillStatus" style="color: #27ae60; display: none;">(ìë™ì¶©ì „ On)</span>
    </div>

    <a href="/admin/dashboard"
        style="display: block; text-align: center; margin-top: 20px; text-decoration: none; color: #1a1a1a; font-weight: 900;">ğŸ”™
        ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script>
    async function loadData() {
        // 1. Get Wallet Info
        try {
            const res = await fetch('/api/admin/auto-reply/settings');
            const data = await res.json();
            document.getElementById('walletBalance').innerText = data.wallet_balance.toLocaleString();
            if (data.auto_refill_on == 1) {
                document.getElementById('autoRefillStatus').style.display = 'inline';
            }
        } catch (e) { }

        // 2. Get Orders (Mock for demo)
        // In real implementation, fetch from /api/admin/orders?type=FARM
    }

    // Daum Postcode
    var element_layer = document.getElementById('layer');

    function closeDaumPostcode() {
        element_layer.style.display = 'none';
    }

    function searchAddress(orderId) {
        new daum.Postcode({
            oncomplete: function (data) {
                var addr = data.address; // Final Address
                var extraAddr = '';

                if (data.addressType === 'R') {
                    if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                        extraAddr += data.bname;
                    }
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if (extraAddr !== '') {
                        extraAddr = ' (' + extraAddr + ')';
                    }
                }

                document.getElementById('address_' + orderId).value = addr + extraAddr;
                element_layer.style.display = 'none';
            },
            width: '100%',
            height: '100%',
            maxSuggestItems: 5
        }).embed(element_layer);

        element_layer.style.display = 'block';
        initLayerPosition();
    }

    function initLayerPosition() {
        var width = 300;
        var height = 400;
        var borderWidth = 5;

        element_layer.style.width = width + 'px';
        element_layer.style.height = height + 'px';
        element_layer.style.border = borderWidth + 'px solid';
        element_layer.style.left = (((window.innerWidth || document.documentElement.clientWidth) - width) / 2 - borderWidth) + 'px';
        element_layer.style.top = (((window.innerHeight || document.documentElement.clientHeight) - height) / 2 - borderWidth) + 'px';
    }

    async function bookLogen(orderId) {
        const address = document.getElementById('address_' + orderId).value;
        if (!address) {
            alert("ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!confirm("ë¡œì  íƒë°° ì ‘ìˆ˜ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì£¼ì†Œ: " + address)) return;

        try {
            // Mock API Call
            /*
            const res = await fetch('/api/logen/book', {
                method: 'POST',
                body: JSON.stringify({order_id: orderId})
            });
            */

            // Simulate Success
            alert("ë¡œì  íƒë°° ì ‘ìˆ˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì†¡ì¥ë²ˆí˜¸: 987-6543-2100");
            location.reload();

        } catch (e) {
            alert("ì ‘ìˆ˜ ì‹¤íŒ¨");
        }
    }

    window.onload = loadData;
</script>
{% endblock %}